<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MediaRecorder Streamer and Capture</title>
    <!-- <script src="./script.js"></script> -->
  </head>

  <body>
    <!-- <h1>My MediaRecorder Streamer</h1>
    <video id="video" width="720" height="480"></video
    ><span id="time">00:00</span> <button id="startBtn">Record</button
    ><button id="stopBtn" disabled>Stop</button> -->
    <div>
      <button id="request" onclick="requestVideo()">Request Camera</button>
      <button id="start" onclick="startRecording()">Start Recording</button>
      <button id="stop" onclick="stopRecording()">Stop Recording</button>
      <ul id="ul">
        Downloads List:
      </ul>
    </div>
    <video
      id="gum"
      width="720"
      height="480"
      controls
      autoplay
      playsinline
      muted
    ></video>

    <video id="video" autoplay></video>
    <script>
      var video,
        reqBtn,
        startBtn,
        stopBtn,
        ul,
        stream,
        recorder,
        streamletRecorder,
        streamletUpload;
      video = document.getElementById("video");
      reqBtn = document.getElementById("request");
      startBtn = document.getElementById("start");
      stopBtn = document.getElementById("stop");
      ul = document.getElementById("ul");
      startBtn.disabled = true;
      ul.style.display = "none";
      stopBtn.disabled = true;
      const mediaStream = new MediaStream();

      function requestVideo() {
        navigator.mediaDevices
          .getUserMedia({
            video: true,
            audio: true,
          })
          .then((stm) => {
            stream = stm;
            reqBtn.style.display = "none";
            startBtn.removeAttribute("disabled");
            video.srcObject = mediaStream;
            const gumVideo = document.querySelector("video#gum");
            gumVideo.srcObject = stream;
          })
          .catch((e) => console.error(e));
      }

      function startRecording() {
        recorder = new MediaRecorder(stream, {
          mimeType: 'video/webm;codecs=h264,vp9,opus"',
          bitsPerSecond: 5000000,
        });
        streamletRecorder = new MediaRecorder(stream, {
          mimeType: 'video/webm;codecs=h264,vp9,opus"',
          bitsPerSecond: 5000000,
        });
        recorder.start();
        streamletRecorder.start();
        uploadStreamlet();
        stopBtn.removeAttribute("disabled");
        startBtn.disabled = true;
      }

      function uploadStreamlet() {
        setInterval(() => {
          if (streamletRecorder.state === "recording") {
            console.log("streamler recorder state:" + streamletRecorder.state);
            console.log("recorder state:" + recorder.state);
            streamletRecorder.stop();
            streamletRecorder.ondataavailable = (e) => {
              ul.style.display = "block";
              var a = document.createElement("a"),
                li = document.createElement("li");
              a.download = [
                "streamlet_video_",
                (new Date() + "").slice(4, 28),
                ".webm",
              ].join("");
              a.href = URL.createObjectURL(e.data);
              a.textContent = a.download;
              li.appendChild(a);
              ul.appendChild(li);
            };
            streamletRecorder.start();
          } else {
            clearInterval;
          }
        }, 3000);
      }

      function stopRecording() {
        recorder.ondataavailable = (e) => {
          ul.style.display = "block";
          var a = document.createElement("a"),
            li = document.createElement("li");
          a.download = [
            "full_video_",
            (new Date() + "").slice(4, 28),
            ".webm",
          ].join("");
          a.href = URL.createObjectURL(e.data);
          a.textContent = a.download;
          li.appendChild(a);
          ul.appendChild(li);
        };
        recorder.stop();
        streamletRecorder.stop();
        startBtn.removeAttribute("disabled");
        stopBtn.disabled = true;
      }
    </script>
  </body>
</html>
